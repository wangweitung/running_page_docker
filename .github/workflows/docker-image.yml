name: 自动化构建 Running Page Docker 镜像

# 触发条件：1. 推送到main分支 2. 手动触发
on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      app_type:
        description: '要构建的平台类型（NRC/Garmin/Garmin-CN/Strava/Nike_to_Strava/Keep）'
        required: true
        default: 'Strava'

# 配置权限
permissions:
  contents: read
  packages: write # 推送到GitHub Packages需要

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取仓库源码
      - name: 检出代码
        uses: actions/checkout@v4

      # 2. 设置Docker Buildx（支持多架构构建）
      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. 构建Docker镜像（根据输入的平台类型传参）
      - name: 构建镜像
        run: |
          # 定义构建参数（根据app_type适配，这里以Strava为例，可扩展其他平台）
          if [ "${{ github.event.inputs.app_type }}" = "Strava" ]; then
            docker build -t running_page:${{ github.sha }} . \
              --build-arg app=Strava \
              --build-arg client_id="${{ secrets.STRAVA_CLIENT_ID }}" \
              --build-arg client_secret="${{ secrets.STRAVA_CLIENT_SECRET }}" \
              --build-arg refresh_token="${{ secrets.STRAVA_REFRESH_TOKEN }}"
          elif [ "${{ github.event.inputs.app_type }}" = "NRC" ]; then
            docker build -t running_page:${{ github.sha }} . \
              --build-arg app=NRC \
              --build-arg nike_refresh_token="${{ secrets.NIKE_REFRESH_TOKEN }}"
          # 可继续添加Garmin/Keep等平台的分支逻辑
          fi

      # （可选）4. 推送到Docker Hub
      - name: 登录Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        if: success()

      - name: 推送镜像到Docker Hub
        run: |
          docker tag running_page:${{ github.sha }} ${{ secrets.DOCKER_HUB_USERNAME }}/running_page:latest
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/running_page:latest
        if: success()

      # （可选）5. 推送到GitHub Packages
      - name: 登录GitHub Packages
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
        if: success()

      - name: 推送镜像到GitHub Packages
        run: |
          docker tag running_page:${{ github.sha }} ghcr.io/${{ github.repository_owner }}/running_page:latest
          docker push ghcr.io/${{ github.repository_owner }}/running_page:latest
        if: success()

name: è‡ªåŠ¨åŒ–æ„å»º Running Page Docker é•œåƒ

# è§¦å‘æ¡ä»¶ï¼š1. æ¨é€åˆ°mainåˆ†æ”¯ 2. æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      app_type:
        description: 'è¦æ„å»ºçš„å¹³å°ç±»å‹ï¼ˆNRC/Garmin/Garmin-CN/Strava/Nike_to_Strava/Keepï¼‰'
        required: true
        default: 'Strava'

# é…ç½®æƒé™
permissions:
  contents: read
  packages: write # æ¨é€åˆ°GitHub Packageséœ€è¦
  id-token: write # å¯é€‰ï¼Œå¢å¼ºå®‰å…¨æ€§

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    # å®šä¹‰ç¯å¢ƒå˜é‡ä¸­è½¬Secretï¼ˆå…³é”®ï¼šè§£å†³ifä¸­æ— æ³•ç›´æ¥ç”¨secretsçš„é—®é¢˜ï¼‰
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    steps:
      # 1. æ‹‰å–ä»“åº“æºç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # 2. è®¾ç½®Docker Buildxï¼ˆæ”¯æŒå¤šæ¶æ„æ„å»ºï¼‰
      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true # ç¡®ä¿å®‰è£…æœ€æ–°ç‰ˆbuildx
          driver-opts: network=host # ä¼˜åŒ–ç½‘ç»œ

      # 3. æ„å»ºDockeré•œåƒï¼ˆå…¼å®¹è‡ªåŠ¨/æ‰‹åŠ¨è§¦å‘ï¼Œå¤šæ¶æ„ï¼‰
      - name: æ„å»ºé•œåƒ
        id: build-image
        run: |
          # å…¼å®¹è‡ªåŠ¨è§¦å‘ï¼ˆpushï¼‰å’Œæ‰‹åŠ¨è§¦å‘çš„app_type
          APP_TYPE="${{ github.event.inputs.app_type || 'Strava' }}"
          echo "ğŸ”¨ å¼€å§‹æ„å»º ${APP_TYPE} å¹³å°é•œåƒï¼Œæ¶æ„ï¼šlinux/amd64,linux/arm64"
          
          # åˆ›å»ºå¹¶ä½¿ç”¨buildxæ„å»ºå™¨
          docker buildx create --use --name=multi-arch-builder --driver docker-container
          
          # æŒ‰å¹³å°ç±»å‹æ„å»º
          if [ "$APP_TYPE" = "Strava" ]; then
            docker buildx build -t running_page:${{ github.sha }} \
              --platform linux/amd64,linux/arm64 \
              --build-arg app=Strava \
              --build-arg client_id="${{ secrets.STRAVA_CLIENT_ID }}" \
              --build-arg client_secret="${{ secrets.STRAVA_CLIENT_SECRET }}" \
              --build-arg refresh_token="${{ secrets.STRAVA_REFRESH_TOKEN }}" \
              --load .
          elif [ "$APP_TYPE" = "NRC" ]; then
            docker buildx build -t running_page:${{ github.sha }} \
              --platform linux/amd64,linux/arm64 \
              --build-arg app=NRC \
              --build-arg nike_refresh_token="${{ secrets.NIKE_REFRESH_TOKEN }}" \
              --load .
          elif [ "$APP_TYPE" = "Garmin" ]; then
            docker buildx build -t running_page:${{ github.sha }} \
              --platform linux/amd64,linux/arm64 \
              --build-arg app=Garmin \
              --build-arg secret_string="${{ secrets.GARMIN_SECRET_STRING }}" \
              --load .
          elif [ "$APP_TYPE" = "Keep" ]; then
            docker buildx build -t running_page:${{ github.sha }} \
              --platform linux/amd64,linux/arm64 \
              --build-arg app=Keep \
              --build-arg keep_cookie="${{ secrets.KEEP_COOKIE }}" \
              --load .
          else
            echo "âŒ ä¸æ”¯æŒçš„å¹³å°ç±»å‹ï¼š${APP_TYPE}"
            exit 1
          fi

      # 4. æ¨é€åˆ°Docker Hubï¼ˆå¯é€‰ï¼‰
      - name: ç™»å½•Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}
        # ä¿®å¤ï¼šifä¸­åˆ¤æ–­ç¯å¢ƒå˜é‡ï¼ˆè€Œéç›´æ¥åˆ¤æ–­secretsï¼‰
        if: success() && env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != ''

      - name: æ¨é€é•œåƒåˆ°Docker Hub
        run: |
          echo "ğŸ“¤ æ¨é€é•œåƒåˆ° Docker Hubï¼š${{ env.DOCKERHUB_USERNAME }}/running_page:latest"
          docker tag running_page:${{ github.sha }} ${{ env.DOCKERHUB_USERNAME }}/running_page:latest
          docker push ${{ env.DOCKERHUB_USERNAME }}/running_page:latest
        # ä¿®å¤ï¼šifä¸­åˆ¤æ–­ç¯å¢ƒå˜é‡
        if: success() && env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != ''

      # 5. æ¨é€åˆ°GitHub Packagesï¼ˆå¯é€‰ï¼‰
      - name: ç™»å½•GitHub Packages
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
        if: success()

      - name: æ¨é€é•œåƒåˆ°GitHub Packages
        run: |
          echo "ğŸ“¤ æ¨é€é•œåƒåˆ° GitHub Packagesï¼šghcr.io/${{ github.repository_owner }}/running_page:latest"
          docker tag running_page:${{ github.sha }} ghcr.io/${{ github.repository_owner }}/running_page:latest
          docker push ghcr.io/${{ github.repository_owner }}/running_page:latest
        if: success()
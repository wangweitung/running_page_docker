name: Daily Check and Build

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 00:00 æ£€æŸ¥ï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶æž„å»º'
        required: false
        default: 'false'
        type: boolean

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Check for updates
      id: check_updates
      run: |
        # èŽ·å–ç›®æ ‡ä»“åº“çš„æœ€æ–°æäº¤
        echo "æ­£åœ¨æ£€æŸ¥ yihong0618/running_page ä»“åº“æ›´æ–°..."
        LATEST_COMMIT=$(curl -s -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/yihong0618/running_page/commits/main | \
          jq -r '.sha')
        
        # è¯»å–æœ¬åœ°å­˜å‚¨çš„ä¸Šæ¬¡æž„å»ºçš„commit
        if [ -f "last_build_commit.txt" ]; then
          LAST_COMMIT=$(cat last_build_commit.txt)
          echo "ä¸Šæ¬¡æž„å»ºçš„commit: ${LAST_COMMIT:0:8}"
        else
          LAST_COMMIT=""
          echo "è¿™æ˜¯ç¬¬ä¸€æ¬¡æž„å»º"
        fi
        
        echo "æœ€æ–°çš„commit: ${LATEST_COMMIT:0:8}"
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåˆ¶æž„å»º
        FORCE_BUILD="${{ github.event.inputs.force_build }}"
        
        if [ "$FORCE_BUILD" = "true" ]; then
          echo "ðŸ§ª å¼ºåˆ¶æž„å»ºæ¨¡å¼"
          echo "should_build=true" >> $GITHUB_OUTPUT
          echo "build_reason=forced" >> $GITHUB_OUTPUT
        elif [ "$LAST_COMMIT" != "$LATEST_COMMIT" ] || [ -z "$LAST_COMMIT" ]; then
          echo "ðŸŽ‰ å‘çŽ°æ–°ç‰ˆæœ¬ï¼Œéœ€è¦æž„å»º"
          echo "should_build=true" >> $GITHUB_OUTPUT
          echo "build_reason=new_commit" >> $GITHUB_OUTPUT
        else
          echo "âœ… æ²¡æœ‰æ›´æ–°ï¼Œè·³è¿‡æž„å»º"
          echo "should_build=false" >> $GITHUB_OUTPUT
        fi
        
        # ä¿å­˜æ–°çš„commit
        echo "$LATEST_COMMIT" > last_build_commit.txt
        echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_ENV

    - name: Build and push Docker image
      if: steps.check_updates.outputs.should_build == 'true'
      run: |
        # èŽ·å–å½“å‰æ—¥æœŸä½œä¸ºæ ‡ç­¾
        DATE_TAG=$(date +'%Y%m%d')
        echo "ðŸ“¦ å¼€å§‹æž„å»º Docker é•œåƒ..."
        echo "æ ‡ç­¾: ${{ secrets.DOCKERHUB_USERNAME }}/running-page:$DATE_TAG"
        
        # å…‹éš†ç›®æ ‡ä»“åº“
        echo "å…‹éš† running_page ä»“åº“..."
        git clone --depth 1 https://github.com/yihong0618/running_page.git source-repo
        
        # åˆ›å»º Dockerfile
        echo "åˆ›å»º Dockerfile..."
        cat > Dockerfile << 'EOF'
        # ç¬¬ä¸€é˜¶æ®µï¼šæž„å»º
        FROM node:18-alpine AS builder

        WORKDIR /app

        # å¤åˆ¶ package.json å¹¶å®‰è£…ä¾èµ–
        COPY source-repo/package*.json ./
        RUN npm ci

        # å¤åˆ¶æºä»£ç 
        COPY source-repo/ .

        # å®‰è£…ä¾èµ–å¹¶æž„å»º
        RUN npm run build

        # ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œ
        FROM node:18-alpine

        WORKDIR /app

        # å®‰è£… serve æ¥æä¾›é™æ€æ–‡ä»¶
        RUN npm install -g serve

        # ä»Žæž„å»ºé˜¶æ®µå¤åˆ¶æž„å»ºäº§ç‰©
        COPY --from=builder /app/public ./public
        COPY --from=builder /app/.next/static ./.next/static

        # æš´éœ²ç«¯å£
        EXPOSE 3000

        # å¯åŠ¨æœåŠ¡
        CMD ["serve", "-s", "public", "-l", "3000"]
        EOF
        
        # æŸ¥çœ‹ Dockerfile å†…å®¹
        echo "=== Dockerfile å†…å®¹ ==="
        cat Dockerfile
        echo "======================"
        
        # æž„å»ºé•œåƒ
        echo "å¼€å§‹æž„å»ºé•œåƒ..."
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          -t ${{ secrets.DOCKERHUB_USERNAME }}/running-page:$DATE_TAG \
          -t ${{ secrets.DOCKERHUB_USERNAME }}/running-page:latest \
          --push \
          .
        
        echo "âœ… é•œåƒæž„å»ºå¹¶æŽ¨é€å®Œæˆï¼"

    - name: Commit and push changes
      if: steps.check_updates.outputs.should_build == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æäº¤æ›´æ”¹
        if [ -n "$(git status --porcelain)" ]; then
          git add last_build_commit.txt
          git commit -m "chore: update last build commit to ${{ env.latest_commit }}"
          git push
          echo "âœ… æäº¤äº†æ–°çš„æž„å»ºè®°å½•"
        else
          echo "âš ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        fi

    - name: Notification summary
      if: always()
      run: |
        echo "=== æž„å»ºæ€»ç»“ ==="
        echo "æž„å»ºçŠ¶æ€: ${{ job.status }}"
        if [ "${{ steps.check_updates.outputs.should_build }}" = "true" ]; then
          echo "æž„å»ºåŽŸå› : ${{ steps.check_updates.outputs.build_reason }}"
          echo "é•œåƒæ ‡ç­¾: ${{ secrets.DOCKERHUB_USERNAME }}/running-page:latest"
          echo "æ—¥æœŸæ ‡ç­¾: ${{ secrets.DOCKERHUB_USERNAME }}/running-page:$(date +'%Y%m%d')"
        else
          echo "æœ¬æ¬¡æœªæž„å»º"
        fi

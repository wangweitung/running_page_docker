name: è‡ªåŠ¨åŒ–æ„å»º Running Page Docker é•œåƒ

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      app_type:
        description: 'è¦æ„å»ºçš„å¹³å°ç±»å‹ï¼ˆNRC/Garmin/Garmin-CN/Strava/Nike_to_Strava/Keepï¼‰'
        required: true
        default: 'Keep'

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      # æºç ä»“åº“åœ°å€
      RUNNING_PAGE_REPO: https://github.com/yihong0618/running_page
      # æºç å…‹éš†åçš„ç›®å½•
      SRC_DIR: ./running_page_src

    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: å…‹éš†running_pageæºç ä»“åº“
        run: |
          echo "ğŸ“¥ å¼€å§‹å…‹éš† running_page æºç ä»“åº“"
          git clone ${{ env.RUNNING_PAGE_REPO }} ${{ env.SRC_DIR }}
          # è¿›å…¥æºç ç›®å½•ï¼Œç¡®è®¤Dockerfileå­˜åœ¨
          cd ${{ env.SRC_DIR }}
          if [ ! -f Dockerfile ]; then
            echo "âŒ æºç ç›®å½•ä¸­æœªæ‰¾åˆ°Dockerfile"
            exit 1
          fi
          echo "âœ… æºç å…‹éš†å®Œæˆï¼ŒDockerfileå­˜åœ¨"

      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container
          driver-opts: network=host
          buildkitd-flags: --debug
          platforms: linux/amd64 # ä»…ä¿ç•™amd64æ¶æ„

      - name: æ„å»ºDockeré•œåƒ
        id: build-image
        run: |
          # è·å–æ„å»ºç±»å‹ï¼ˆæ‰‹åŠ¨è§¦å‘ä¼˜å…ˆï¼Œé»˜è®¤Keepï¼‰
          APP_TYPE="${{ github.event.inputs.app_type || 'Keep' }}"
          echo "ğŸ”¨ å¼€å§‹æ„å»º ${APP_TYPE} å¹³å°é•œåƒï¼Œæ¶æ„ï¼šlinux/amd64"
          
          # è¿›å…¥æºç ç›®å½•æ‰§è¡Œæ„å»º
          cd ${{ env.SRC_DIR }}
          
          # åˆå§‹åŒ–æ„å»ºå‚æ•°
          BUILD_ARGS=""
          case $APP_TYPE in
            Strava)
              BUILD_ARGS="--build-arg app=Strava \
                --build-arg client_id=${{ secrets.STRAVA_CLIENT_ID }} \
                --build-arg client_secret=${{ secrets.STRAVA_CLIENT_SECRET }} \
                --build-arg refresh_token=${{ secrets.STRAVA_REFRESH_TOKEN }}"
              ;;
            NRC)
              BUILD_ARGS="--build-arg app=NRC \
                --build-arg nike_refresh_token=${{ secrets.NIKE_REFRESH_TOKEN }}"
              ;;
            Garmin)
              BUILD_ARGS="--build-arg app=Garmin \
                --build-arg secret_string=${{ secrets.GARMIN_SECRET_STRING }}"
              ;;
            Garmin-CN)
              BUILD_ARGS="--build-arg app=Garmin-CN \
                --build-arg secret_string=${{ secrets.GARMIN_CN_SECRET_STRING }}"
              ;;
            Nike_to_Strava)
              BUILD_ARGS="--build-arg app=Nike_to_Strava \
                --build-arg nike_refresh_token=${{ secrets.NIKE_REFRESH_TOKEN }} \
                --build-arg strava_client_id=${{ secrets.STRAVA_CLIENT_ID }} \
                --build-arg strava_client_secret=${{ secrets.STRAVA_CLIENT_SECRET }} \
                --build-arg strava_refresh_token=${{ secrets.STRAVA_REFRESH_TOKEN }}"
              ;;
            Keep)
              # é€‚é…ä½ è¦æ±‚çš„keep_phone_numberå’Œkeep_passwordå‚æ•°
              BUILD_ARGS="--build-arg app=Keep \
                --build-arg keep_phone_number=${{ secrets.KEEP_PHONE_NUMBER }} \
                --build-arg keep_password=${{ secrets.KEEP_PASSWORD }}"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„å¹³å°ç±»å‹ï¼š${APP_TYPE}"
              exit 1
              ;;
          esac
          
          # æ„å»ºé•œåƒï¼ˆå•æ¶æ„ç›´æ¥loadåˆ°æœ¬åœ°ï¼‰
          docker buildx build -t running_page:${{ github.sha }} \
            --platform linux/amd64 \
            $BUILD_ARGS \
            --load .

      - name: ç™»å½•Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}
        if: success() && env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != ''

      - name: æ¨é€é•œåƒåˆ°Docker Hub
        run: |
          # å¢åŠ APP_TYPEæ ‡ç­¾ï¼Œæ–¹ä¾¿åŒºåˆ†ä¸åŒå¹³å°é•œåƒ
          TAG_LATEST="${{ env.DOCKERHUB_USERNAME }}/running_page:latest"
          TAG_APP="${{ env.DOCKERHUB_USERNAME }}/running_page:${{ github.event.inputs.app_type || 'Keep' }}-${{ github.sha }}"
          
          echo "ğŸ“¤ æ¨é€é•œåƒåˆ° Docker Hubï¼š${TAG_LATEST}"
          docker tag running_page:${{ github.sha }} $TAG_LATEST
          docker push $TAG_LATEST
          
          echo "ğŸ“¤ æ¨é€å¹³å°ä¸“å±é•œåƒï¼š${TAG_APP}"
          docker tag running_page:${{ github.sha }} $TAG_APP
          docker push $TAG_APP
        if: success() && env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != ''

      - name: ç™»å½•GitHub Packages
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
        if: success()

      - name: æ¨é€é•œåƒåˆ°GitHub Packages
        run: |
          # åŒæ ·å¢åŠ å¹³å°æ ‡ç­¾
          TAG_LATEST="ghcr.io/${{ github.repository_owner }}/running_page:latest"
          TAG_APP="ghcr.io/${{ github.repository_owner }}/running_page:${{ github.event.inputs.app_type || 'Keep' }}-${{ github.sha }}"
          
          echo "ğŸ“¤ æ¨é€é•œåƒåˆ° GitHub Packagesï¼š${TAG_LATEST}"
          docker tag running_page:${{ github.sha }} $TAG_LATEST
          docker push $TAG_LATEST
          
          echo "ğŸ“¤ æ¨é€å¹³å°ä¸“å±é•œåƒï¼š${TAG_APP}"
          docker tag running_page:${{ github.sha }} $TAG_APP
          docker push $TAG_APP
        if: success()
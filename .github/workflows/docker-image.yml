name: è‡ªåŠ¨åŒ–æ„å»º Running Page Docker é•œåƒ

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      app_type:
        description: 'è¦æ„å»ºçš„å¹³å°ç±»å‹ï¼ˆNRC/Garmin/Garmin-CN/Strava/Nike_to_Strava/Keepï¼‰'
        required: true
        default: 'Strava'

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      # æ–°å¢ï¼šæŒ‡å®šBuildxæ„å»ºå™¨ï¼ˆæ›¿ä»£installå‚æ•°ï¼‰
      BUILDX_BUILDER: multi-arch-builder
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ä¿®å¤ï¼šç§»é™¤åºŸå¼ƒçš„installå‚æ•°ï¼Œæ”¹ç”¨é¢„åˆ›å»ºæ„å»ºå™¨
      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container # æ˜¾å¼æŒ‡å®šå®¹å™¨é©±åŠ¨ï¼ˆæ›´ç¨³å®šï¼‰
          driver-opts: network=host
          # é¢„åˆ›å»ºå¤šæ¶æ„æ„å»ºå™¨ï¼ˆæ›¿ä»£æ‰‹åŠ¨createï¼‰
          buildkitd-flags: --debug
          platforms: linux/amd64,linux/arm64 # é¢„è®¾æ”¯æŒçš„æ¶æ„

      # ä¿®å¤æ„å»ºæ­¥éª¤ï¼šç§»é™¤æ‰‹åŠ¨createæ„å»ºå™¨ï¼Œç›´æ¥ä½¿ç”¨é¢„è®¾çš„BUILDX_BUILDER
      - name: æ„å»ºDockeré•œåƒ
        id: build-image
        run: |
          APP_TYPE="${{ github.event.inputs.app_type || 'Strava' }}"
          echo "ğŸ”¨ å¼€å§‹æ„å»º ${APP_TYPE} å¹³å°é•œåƒï¼Œæ¶æ„ï¼šlinux/amd64,linux/arm64"
          
          # æ— éœ€æ‰‹åŠ¨createæ„å»ºå™¨ï¼ˆsetup-buildx-actionå·²è‡ªåŠ¨åˆ›å»ºï¼‰
          # ç›´æ¥ä½¿ç”¨BUILDX_BUILDERç¯å¢ƒå˜é‡æŒ‡å®šçš„æ„å»ºå™¨
          docker buildx use $BUILDX_BUILDER
          
          # ç»Ÿä¸€æ„å»ºé€»è¾‘ï¼ˆç®€åŒ–é‡å¤ä»£ç ï¼‰
          BUILD_ARGS=""
          case $APP_TYPE in
            Strava)
              BUILD_ARGS="--build-arg app=Strava \
                --build-arg client_id=${{ secrets.STRAVA_CLIENT_ID }} \
                --build-arg client_secret=${{ secrets.STRAVA_CLIENT_SECRET }} \
                --build-arg refresh_token=${{ secrets.STRAVA_REFRESH_TOKEN }}"
              ;;
            NRC)
              BUILD_ARGS="--build-arg app=NRC \
                --build-arg nike_refresh_token=${{ secrets.NIKE_REFRESH_TOKEN }}"
              ;;
            Garmin)
              BUILD_ARGS="--build-arg app=Garmin \
                --build-arg secret_string=${{ secrets.GARMIN_SECRET_STRING }}"
              ;;
            Keep)
              BUILD_ARGS="--build-arg app=Keep \
                --build-arg keep_cookie=${{ secrets.KEEP_COOKIE }}"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„å¹³å°ç±»å‹ï¼š${APP_TYPE}"
              exit 1
              ;;
          esac
          
          # æ‰§è¡Œå¤šæ¶æ„æ„å»ºï¼ˆ--loadä»…æ”¯æŒå•æ¶æ„ï¼Œæ”¹ç”¨--pushåˆ°æœ¬åœ°registryæˆ–ç›´æ¥æ¨é€ï¼‰
          # æ³¨æ„ï¼š--loadæ— æ³•åŒæ—¶åŠ è½½å¤šæ¶æ„ï¼Œè‹¥éœ€æœ¬åœ°æµ‹è¯•å¯æ‹†åˆ†æ¶æ„ï¼Œæˆ–ç›´æ¥æ¨é€ä»“åº“
          docker buildx build -t running_page:${{ github.sha }} \
            --platform linux/amd64,linux/arm64 \
            $BUILD_ARGS \
            --output type=docker,dest=/tmp/running_page.tar .
          
          # å¯¼å…¥é•œåƒåˆ°æœ¬åœ°Dockerï¼ˆå…¼å®¹å¤šæ¶æ„ï¼‰
          docker load < /tmp/running_page.tar

      - name: ç™»å½•Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}
        if: success() && env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != ''

      - name: æ¨é€é•œåƒåˆ°Docker Hub
        run: |
          echo "ğŸ“¤ æ¨é€é•œåƒåˆ° Docker Hubï¼š${{ env.DOCKERHUB_USERNAME }}/running_page:latest"
          docker tag running_page:${{ github.sha }} ${{ env.DOCKERHUB_USERNAME }}/running_page:latest
          docker push ${{ env.DOCKERHUB_USERNAME }}/running_page:latest
        if: success() && env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != ''

      - name: ç™»å½•GitHub Packages
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
        if: success()

      - name: æ¨é€é•œåƒåˆ°GitHub Packages
        run: |
          echo "ğŸ“¤ æ¨é€é•œåƒåˆ° GitHub Packagesï¼šghcr.io/${{ github.repository_owner }}/running_page:latest"
          docker tag running_page:${{ github.sha }} ghcr.io/${{ github.repository_owner }}/running_page:latest
          docker push ghcr.io/${{ github.repository_owner }}/running_page:latest
        if: success()